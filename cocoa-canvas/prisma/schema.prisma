// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION (Phase 1)
// ============================================================================

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String?
  passwordHash String
  isActive     Boolean @default(true)

  // Session/login tracking
  lastLogin     DateTime?
  loginAttempts Int       @default(0)
  lockedUntil   DateTime?

  // Relations
  sessions      Session[]
  auditLogs     AuditLog[]
  jobsCreated   Job[]
  scheduledJobs ScheduledJob[]
  gisDatasets   GISDataset[]  // Datasets created by this user
  remoteDatasets RemoteGISDataset[] // Remote datasets discovered by this user

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Session {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

// ============================================================================
// CAMPAIGN (Single Campaign Per Deployment)
// ============================================================================
// Only ONE campaign record exists per deployment (single political race).
// Campaign metadata is stored here. For multi-race support, deploy multiple instances.

model Campaign {
  id String @id @default(cuid())

  // Single campaign metadata
  name        String // e.g., "Jane Smith for Mayor 2026"
  description String?

  // Timeline
  startDate DateTime
  endDate   DateTime
  status    String   @default("planning") // planning, active, paused, completed

  // Target area (jurisdiction)
  targetArea String? // e.g., "San Francisco County"

  // Configuration
  color   String  @default("#6B4423") // Campaign brand color
  logoUrl String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Enforce single record via unique constraint
  @@unique([id])
}

// ============================================================================
// JOB QUEUE (Phase 1 - Generic async job tracking)
// ============================================================================

model Job {
  id String @id @default(cuid())

  // Job metadata
  type   String // "import_voters", "geocode", "export", etc.
  status String @default("pending") // pending, processing, completed, failed
  isDynamic Boolean @default(false) // true when work is discovered on-demand during processing

  // Progress
  totalItems     Int @default(0)
  processedItems Int @default(0)

  // Error tracking
  errorLog String? // JSON array of errors (stored as text)

  // Output statistics (stored as JSON text for flexibility)
  // Track job-specific metrics like records processed, bytes processed, etc.
  outputStats String?
  // Example: { recordsProcessed: 100, recordsCreated: 50, bytesProcessed: 45000, percentComplete: 45 }

  // Job-specific data (stored as JSON text for flexibility)
  data String?
  // Example: { filePath: "/uploads/voters.txt", importType: "contra_costa", action: "merge" }

  // Timestamps
  createdById String?
  createdBy   User?     @relation(fields: [createdById], references: [id])
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// SCHEDULED JOBS (Recurring/Cron Jobs)
// ============================================================================

model ScheduledJob {
  id String @id @default(cuid())

  // Job identification
  name        String  @unique // "daily-voter-sync", "weekly-cleanup", etc.
  description String?
  type        String // "voter_import", "data_cleanup", etc.

  // Scheduling
  schedule String // Cron expression: "0 2 * * *" (2 AM daily)
  enabled  Boolean @default(true)

  // Execution tracking
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  lastStatus String? // "success", "failed", null
  lastError  String?
  runCount   Int       @default(0)

  // Job configuration (stored as JSON)
  data String? // Job-specific parameters

  // Metadata
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([enabled])
  @@index([nextRunAt])
  @@index([type])
}

// ============================================================================
// GEOCODING PROVIDERS (Address geocoding service configuration)
// ============================================================================

model GeocoderProvider {
  id String @id @default(cuid())

  // Provider identification
  providerId String @unique // e.g., "nominatim", "locationiq", "opencage"
  providerName String // Human-readable: "Nominatim", "LocationIQ", etc.
  description String?

  // Configuration
  isEnabled Boolean @default(true)
  isPrimary Boolean @default(false) // Only one provider can be primary
  priority Int @default(0) // For sorting/fallback order

  // API Configuration (stored as JSON for flexibility)
  // Example: { "apiKey": "xxx", "baseUrl": "https://api.provider.com", "rateLimit": 1000 }
  config String? // JSON object with provider-specific settings

  // Usage tracking
  requestsProcessed Int @default(0)
  requestsFailed Int @default(0)
  lastUsedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([isEnabled])
  @@index([isPrimary])
}

// ============================================================================
// AUDIT LOGGING (Phase 1)
// ============================================================================

model AuditLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  action     String // "login", "logout", "view_dashboard", "create_campaign", etc.
  resource   String? // "user", "campaign", "job", etc.
  resourceId String?

  details   String? // JSON for context (stored as text)
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

// ============================================================================
// VOTER MANAGEMENT (Person-Centric, Multi-Import Architecture)
// ============================================================================

// Political party (normalized)
model Party {
  id String @id @default(cuid())

  // Party identity
  name String @unique // "Democratic", "Republican", "American Independent", etc.
  abbr String @unique // "DEM", "REP", "AIP", "G", "L", "PF", "N", "U"

  // Metadata
  description String? // Full party name or description
  color       String? // Hex color for UI display

  // Relations
  voters      Voter[]
  voteHistory VoteHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([abbr])
}

// Voting precinct (normalized)
model Precinct {
  id String @id @default(cuid())

  // Precinct identity
  number String  @unique // "0001", "0042", "DANV119", etc.
  name   String? // Optional descriptive name

  // Metadata
  description  String?
  pollingPlace String? // Location of polling place
  
  // CATALOG SYNC TRACKING - which dataset sourced this precinct (optional)
  sourceDatasetId String?
  sourceDataset   GISDataset? @relation("PrecinctsSourcingDataset", fields: [sourceDatasetId], references: [id])
  syncedAt        DateTime?   // When it was synced from catalog

  // Relations
  voters Voter[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([number])
}

// Election (shared metadata)
model Election {
  id String @id @default(cuid())

  // Election identity
  electionDate DateTime @unique // 2022-11-08, 2024-11-05, etc.
  electionAbbr String?  @unique // "GEN24", "PRI22", "SP23"
  electionDesc String? // "2024 General Election"
  electionType String? // General, Primary, Special, Recall, etc. (legacy field for backward compat)

  // NEW FIELDS FOR CATALOG
  name            String?     // "November 8, 2022 General Election"
  shortName       String?     // "2022 General"
  
  // Link to configurable ElectionType option group
  electionTypeId  String?
  electionTypeRef ElectionType? @relation(fields: [electionTypeId], references: [id])
  
  jurisdiction    String?     // "California", "Contra Costa County", "Oakland"
  districtLevel   String?     // "statewide", "county", "city", "district"
  description     String?     @db.Text
  isActive        Boolean     @default(true)

  // Metadata
  jurisdictionCode String?

  // Relations
  voteHistory     VoteHistory[]
  contests        Contest[]          // Races/measures on this election date
  precinctDatasets PrecinctDataset[]  // Precinct boundaries for this election

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([electionDate])
  @@index([electionTypeId])
  @@index([jurisdiction])
}


// Parcel (tax lot / property parcel from GIS)
model Parcel {
  id String @id @default(cuid())

  // Address
  streetNumber  String?
  preDirection  String?
  streetName    String
  streetSuffix  String?
  postDirection String?
  city          String
  state         String  @default("CA")
  zipCode       String
  fullAddress   String?

  // GIS Geometry - stored as GeoJSON (FeatureCollection or Polygon)
  geometry String? // JSON string: { "type": "Polygon", "coordinates": [...] }

  // Calculated centroid from geometry (calculated on import/creation)
  centroidLatitude  Float?  // Calculated from geometry if not provided
  centroidLongitude Float?  // Calculated from geometry if not provided

  // External references
  apn          String? // Assessor's Parcel Number (county-specific identifier)
  externalId   String? // Reference to external GIS data source
  externalSource String? // "county_gis", "zillow", etc.

  // Import tracking
  importedFrom String?  // Source system or file
  importedAt   DateTime?
  
  // CATALOG SYNC TRACKING - which dataset sourced this parcel (optional)
  sourceDatasetId String?
  sourceDataset   GISDataset? @relation("ParcelsSourcingDataset", fields: [sourceDatasetId], references: [id])
  syncedAt        DateTime?   // When it was synced from catalog

  // Relations
  households Household[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([apn, externalSource]) // Unique combination of APN + source
  @@index([fullAddress])
  @@index([zipCode])
  @@index([city])
}

// Multi-unit building address
model Building {
  id String @id @default(cuid())

  // Building address
  streetNumber  String
  preDirection  String?
  streetName    String
  streetSuffix  String?
  postDirection String?
  city          String
  state         String  @default("CA")
  zipCode       String
  fullAddress   String  @unique

  // Building metadata
  buildingType String? // "apartment", "condo", "townhouse", "mixed_use"
  totalUnits   Int?

  // Geolocation
  latitude  Float?
  longitude Float?
  geocoded  Boolean @default(false)

  // Relations
  households Household[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fullAddress])
  @@index([zipCode])
}

// Address grouping (household)
model Household {
  id String @id @default(cuid())

  // If this address is within a building
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id])

  // If this household is on a parcel
  parcelId String?
  parcel   Parcel? @relation(fields: [parcelId], references: [id])

  // Address (normalized)
  houseNumber   String?
  preDirection  String?
  streetName    String
  streetSuffix  String?
  postDirection String?
  unitAbbr      String?
  unitNumber    String?
  city          String
  state         String  @default("CA")
  zipCode       String
  fullAddress   String  @unique

  // Derived stats
  personCount    Int  @default(0)
  maxVotingScore Int?

  // Geolocation
  latitude             Float?
  longitude            Float?
  geocoded             Boolean   @default(false)
  geocodedAt           DateTime?
  geocodingProvider    String?   // Which service geocoded this (e.g., "nominatim", "locationiq")

  // Relations
  people Person[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([houseNumber, streetName, zipCode])
  @@index([buildingId])
  @@index([parcelId])
  @@index([city])
  @@index([fullAddress])
  @@index([zipCode])
}

// Core human identity (person-centric)
model Person {
  id String @id @default(cuid())

  // Name components
  title      String? // Mr, Ms, Dr, etc.
  firstName  String
  middleName String?
  lastName   String
  nameSuffix String? // Jr, Sr, III, etc.

  // Demographics
  gender     String? // M, F, U, X
  birthDate  DateTime?
  birthPlace String? // State/Country code
  language   String? // Preferred language

  // Household grouping
  householdId String?
  household   Household? @relation(fields: [householdId], references: [id])

  // Notes
  notes String?

  // Relations
  voter       Voter? // Optional: if this person is registered to vote
  volunteer   Volunteer? // Optional: if this person volunteers
  donor       Donor? // Optional: if this person is a donor
  addresses   Address[]
  phones      Phone[]
  emails      Email[]
  contactLogs ContactLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([firstName, lastName])
  @@index([householdId])
}

// Contact location/type (customizable)
model Location {
  id String @id @default(cuid())

  // Location type
  name     String  @unique // "Home", "Work", "Cell", "Home Email", "Work Address", etc.
  category String? // "phone", "email", "address", "digital" (for grouping)

  // Metadata
  description String? // User-facing description
  isActive    Boolean @default(true)

  // Relations
  addresses Address[]
  phones    Phone[]
  emails    Email[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([category])
}

// Physical address
model Address {
  id String @id @default(cuid())

  // Which person
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Address location/type
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Address components
  houseNumber   String?
  preDirection  String? // N, S, E, W
  streetName    String?
  streetSuffix  String? // St, Ave, Ln, etc.
  postDirection String?
  unitAbbr      String? // Apt, Unit, Ste, etc.
  unitNumber    String?
  city          String?
  state         String? @default("CA")
  zipCode       String?
  fullAddress   String? // Computed/normalized address

  // Verification / Priority
  isPrimary   Boolean @default(false) // Primary address for this location type
  isVerified  Boolean @default(false) // Verified as accurate
  isCurrently Boolean @default(true) // Still current (not "moved")

  // Tracking
  source     String? // "county_file", "csv_import", "user_entry", "enrichment"
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([personId])
  @@index([locationId])
  @@index([isPrimary])
  @@index([isCurrently])
}

// Phone number
model Phone {
  id String @id @default(cuid())

  // Which person
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Phone location/type (Cell, Home, Work, etc.)
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Phone number
  number String // E.164 format: +1-650-253-0000

  // Verification / Priority
  isPrimary        Boolean @default(false) // Primary phone for this location type
  isVerified       Boolean @default(false) // Verified as working
  isCurrently      Boolean @default(true) // Still valid
  violationCount   Int     @default(0) // TCPA violations
  canText          Boolean @default(false) // SMS-capable
  hasConsent       Boolean @default(false) // Has consent for contact
  doNotCall        Boolean @default(false) // On do-not-call list

  // Tracking
  source     String? // "county_file", "csv_import", "user_entry", "enrichment"
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([personId])
  @@index([locationId])
  @@index([number])
  @@index([isPrimary])
  @@index([isCurrently])
}

// Email address
model Email {
  id String @id @default(cuid())

  // Which person
  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Email location/type (Personal, Work, etc.)
  locationId String
  location   Location @relation(fields: [locationId], references: [id])

  // Email address
  address String // Normalized lowercase

  // Verification / Priority
  isPrimary       Boolean @default(false) // Primary email for this location type
  isVerified      Boolean @default(false) // Verified as working
  isCurrently     Boolean @default(true) // Still valid
  bounceCount     Int     @default(0) // Email bounces
  hasConsent      Boolean @default(false) // Has consent for contact
  unsubscribed    Boolean @default(false) // Unsubscribed from emails

  // Tracking
  source     String? // "county_file", "csv_import", "user_entry", "enrichment"
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([personId])
  @@index([locationId])
  @@index([address])
  @@index([isPrimary])
  @@index([isCurrently])
}

// Voter registration profile (specializes Person)
model Voter {
  id String @id @default(cuid())

  // Link to core identity
  personId String @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // External identity (for deduplication across imports)
  externalId         String? // VoterID from county file / RegistrationNumber from CSV
  externalSource     String? // "contra_costa", "simple_csv", etc. (qualifies externalId)
  registrationNumber String? // County's internal voter ID (may differ from externalId)

  // Registration info
  title            String? // Mr, Ms, Dr, etc. (from file)
  registrationDate DateTime?
  partyId          String?
  party            Party?    @relation(fields: [partyId], references: [id])
  vbmStatus        String? // Permanent VBM, Conditional, etc.

  // Precinct (voting location)
  precinctId      String?
  precinct        Precinct? @relation(fields: [precinctId], references: [id])
  precinctPortion String? // Which portion if split

  // Import tracking
  importedFrom String? // Source file name, path, or system
  importType   String? // "full" or "incremental"
  importFormat String? // voter file format identifier
  importFile   String? // SHA hash of source file (anti-duplication)

  // Relations
  voteHistory VoteHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([externalId, externalSource])
  @@index([externalId])
  @@index([registrationNumber])
  @@index([precinctId])
}

// Volunteer profile (specializes Person)
model Volunteer {
  id String @id @default(cuid())

  // Link to core identity
  personId String @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Volunteer info
  status String @default("active") // active, inactive, unavailable
  skills String? // JSON array or comma-separated: "phone_banking,canvassing,data_entry"
  
  // Availability
  availability String? // JSON or text: preferred days/times
  hoursCommitted Int? // Total hours committed
  hoursCompleted Int @default(0) // Hours completed so far
  
  // Assignment tracking
  currentAssignment String? // Description of current task
  teamId String? // Team or group assignment
  
  // Contact preferences
  preferredContactMethod String? // email, phone, sms
  canDrive Boolean @default(false)
  hasOwnEquipment Boolean @default(false) // Own laptop, phone, etc.
  
  // Notes
  notes String?
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([teamId])
}

// Donor profile (specializes Person)
model Donor {
  id String @id @default(cuid())

  // Link to core identity
  personId String @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Donor info
  status String @default("active") // active, lapsed, major, recurring
  totalContributed Float @default(0) // Total lifetime contributions
  lastContributionDate DateTime?
  lastContributionAmount Float?
  
  // Donor tier
  donorTier String? // "sustainer", "major", "monthly", "annual"
  recurringAmount Float? // Monthly recurring amount if applicable
  
  // Preferences
  preferredAskAmount Float? // Suggested ask amount
  doNotContact Boolean @default(false)
  anonymousGiving Boolean @default(false)
  
  // Recognition
  recognitionName String? // How they want to be recognized publicly
  acknowledgeInPublic Boolean @default(true)
  
  // Notes
  notes String?
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([donorTier])
  @@index([lastContributionDate])
}

// Election participation history
model VoteHistory {
  id String @id @default(cuid())

  // Which voter
  voterId String
  voter   Voter  @relation(fields: [voterId], references: [id], onDelete: Cascade)

  // Election reference
  electionId String?
  election   Election? @relation(fields: [electionId], references: [id])

  // Ballot party reference
  ballotPartyId String?
  ballotParty   Party?  @relation(fields: [ballotPartyId], references: [id])

  // Fallback if election not yet created
  electionDate DateTime?
  electionAbbr String?
  electionDesc String?
  electionType String?

  // Participation
  participated Boolean // Did voter participate?
  votingMethod String? // "Absentee", "Polling Place", "Early Voting", "Provisional"

  // Ballot info (legacy fields, keep for backward compat)
  ballotPartyName String? // Full party name on ballot

  // District context
  districtId   String?
  districtName String?

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([voterId, electionDate])
  @@index([voterId])
  @@index([electionDate])
  @@index([participated])
  @@index([votingMethod])
}

// Contact/outreach interaction history
model ContactLog {
  id String @id @default(cuid())

  personId String
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  // Contact details
  method  String // "call", "email", "door_knock", "sms", "mail", etc.
  outcome String? // "reached", "refused", "not_home", "no_answer", "moved", "invalid", "pending"
  notes   String?

  // Optional follow-up
  followUpNeeded Boolean   @default(false)
  followUpDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([personId])
  @@index([method])
  @@index([outcome])
  @@index([createdAt])
}

// ============================================================================
// SETTINGS & CONFIGURATION
// ============================================================================
// Store app-wide settings and campaign configuration
// Examples: "campaign_id", "feature_flags", "email_provider"

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String // Can be JSON (stored as text)

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

// ============================================================================
// OPTION GROUPS (Configurable Reference Lists)
// ============================================================================

// Election Types (Primary, General, Special, etc.)
model ElectionType {
  id           String  @id @default(cuid())
  name         String  @unique // "Primary", "General", "Special", "Runoff", "Recall", "Local"
  description  String? @db.Text
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  // Relations
  elections    Election[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
  @@map("election_types")
}

// Dataset Types (Parcel, Precinct, Demographic, etc.)
model DatasetType {
  id           String  @id @default(cuid())
  name         String  @unique // "Parcel", "Precinct", "Demographic", "Boundary", "Infrastructure", "Custom"
  description  String? @db.Text
  category     String? // Group similar types: "Political", "Property", "Demographics", "Infrastructure"
  isActive     Boolean @default(true)
  displayOrder Int     @default(0)

  // Relations
  datasets     GISDataset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
  @@index([category])
  @@map("dataset_types")
}

// ============================================================================
// GIS CATALOG (Phase 2 - Spatial Dataset Management)
// ============================================================================
// Two-tier architecture:
// Tier 1: CATALOG (GISDataset + dynamic PostGIS tables) = raw imported data
// Tier 2: APPLICATION (Parcel, Precinct) = working data linked to entities
// Sync workflow: Import → Catalog → Validate → "Sync to App" → Application layer

/// PostGIS geometry types (from PostGIS specification)
enum GeometryType {
  POINT
  LINESTRING
  POLYGON
  MULTIPOINT
  MULTILINESTRING
  MULTIPOLYGON
  GEOMETRYCOLLECTION
}

/// Core dataset registry - all GIS and tabular datasets
/// NOTE: This is CATALOG data (import archive), NOT directly linked to Household/Person
/// App models (Parcel, Precinct) are populated by "syncing" from catalog
model GISDataset {
  id              String        @id @default(cuid())
  name            String        @unique
  description     String?       @db.Text
  
  // Link to configurable DatasetType option group
  datasetTypeId   String
  datasetType     DatasetType   @relation(fields: [datasetTypeId], references: [id])
  
  // PostGIS Integration
  // References dynamically created PostGIS tables (not in Prisma schema)
  sourceTable     String?       // e.g., "gis_abc123def456" (actual PostGIS table name)
  geometryColumn  String?       @default("geom")
  geometryType    GeometryType?
  srid            Int           @default(4326) // WGS84 by default
  
  // Spatial extent (for quick map bounds)
  boundingBox     Json?         // {minX, minY, maxX, maxY}
  recordCount     Int?
  
  // Organization
  tags            String[]      // Searchable tags
  category        String?       // "Property", "Political", "Demographics"
  isActive        Boolean       @default(true)
  isPublic        Boolean       @default(false)
  
  // Sync tracking (has this been synced to app models?)
  syncedToApp     Boolean       @default(false)
  lastSyncedToAppAt DateTime?
  syncedRecordCount Int?        // How many records synced to app
  
  // Metadata (flexible storage for dataset-specific attributes)
  metadata        Json?
  
  // Tracking
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdById     String?
  createdBy       User?         @relation(fields: [createdById], references: [id])
  
  // Relations (one-to-one with type-specific metadata)
  parcelDataset       ParcelDataset?
  precinctDataset     PrecinctDataset?
  demographicDataset  DemographicDataset?
  
  // Back-reference for remote datasets that were imported into this catalog dataset
  sourceRemoteDataset RemoteGISDataset?
  
  // Relations to app models (optional tracking)
  parcelsSourced      Parcel[] @relation("ParcelsSourcingDataset")      // Parcels that came from this dataset
  precinctsSourced    Precinct[] @relation("PrecinctsSourcingDataset")  // Precincts that came from this dataset
  
  // Relations to contests (geography-specific contests)
  contestsWithDistrictGeometry Contest[] @relation("ContestDistrictDataset")
  
  @@map("gis_datasets")
  @@index([datasetTypeId])
  @@index([isActive])
  @@index([category])
  @@index([syncedToApp])
}

/// Parcel-specific metadata and field mappings
/// Maps to columns in the dynamically-created PostGIS parcel table
model ParcelDataset {
  id              String      @id @default(cuid())
  datasetId       String      @unique
  dataset         GISDataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  
  // Field mappings (column names in source PostGIS table)
  apnField            String   @default("apn")        // Assessor Parcel Number
  addressField        String?  @default("address")
  cityField           String?  @default("city")
  zipField            String?  @default("zip")
  ownerField          String?  @default("owner")
  assessedValueField  String?  @default("assessed_value")
  landUseField        String?  @default("land_use")
  landUseCodeField    String?  @default("land_use_code")
  yearBuiltField      String?  @default("year_built")
  squareFeetField     String?  @default("square_feet")
  lotSizeField        String?  @default("lot_size")
  bedroomsField       String?  @default("bedrooms")
  bathroomsField      String?  @default("bathrooms")
  
  // Data source information
  sourceAgency    String?     // "Contra Costa County Assessor"
  sourceUrl       String?
  lastUpdated     DateTime?
  updateFrequency String?     // "quarterly", "annually"
  licenseInfo     String?     @db.Text
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("parcel_datasets")
}

/// Precinct-specific metadata - supports election-specific boundaries
/// Different elections may have different precinct boundaries!
model PrecinctDataset {
  id              String      @id @default(cuid())
  datasetId       String      @unique
  dataset         GISDataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  
  // Election context (null = current/default precinct boundaries)
  electionId      String?
  election        Election?   @relation(fields: [electionId], references: [id])
  
  // Field mappings (column names in source PostGIS table)
  precinctIdField     String  @default("precinct_id")
  precinctNameField   String? @default("precinct_name")
  jurisdictionField   String? @default("jurisdiction")
  
  // Data source
  sourceAgency    String?     // "County Registrar of Voters"
  sourceUrl       String?
  effectiveDate   DateTime?   // When these boundaries took effect
  
  // Relations
  electionResults ElectionResult[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("precinct_datasets")
  @@index([electionId])
}

/// Demographic dataset metadata (Census, ACS, etc.)
model DemographicDataset {
  id              String      @id @default(cuid())
  datasetId       String      @unique
  dataset         GISDataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)
  
  // Data source details
  source          String      // "US Census 2020", "ACS 5-Year 2018-2022"
  year            Int         // Reference year
  geographyLevel  String      // "block", "block_group", "tract", "zip", "county"
  
  // Field mappings (common demographic fields)
  geoIdField          String? @default("geoid")
  populationField     String? @default("total_population")
  householdsField     String? @default("households")
  medianIncomeField   String? @default("median_income")
  medianAgeField      String? @default("median_age")
  
  // Race/ethnicity fields
  whiteField          String? @default("white_pop")
  blackField          String? @default("black_pop")
  asianField          String? @default("asian_pop")
  hispanicField       String? @default("hispanic_pop")
  
  // Housing fields
  ownerOccupiedField  String? @default("owner_occupied")
  renterOccupiedField String? @default("renter_occupied")
  medianHomeValueField String? @default("median_home_value")
  
  // Additional field mappings in JSON
  customFields    Json?       // Flexible storage for additional mappings
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("demographic_datasets")
}

/// Remote GIS datasets - references to external ArcGIS services
/// These can be discovered through the map explorer and imported into the catalog
model RemoteGISDataset {
  id              String        @id @default(cuid())
  
  // Remote service reference
  serviceUrl      String        // e.g., "https://gis.cccounty.us/arcgis/rest/services/CCMAP/Assessment_Parcels_ArcPro/MapServer"
  layerId         Int           // Layer ID within the service (e.g., 0)
  
  // Layer metadata from service
  layerName       String        // Name from service (e.g., "Assessment Parcels")
  layerType       String?       // "Feature Layer", "Raster Layer", "Table", etc.
  geometryType    String?       // "esriGeometryPoint", "esriGeometryPolyline", "esriGeometryPolygon"
  
  // Service metadata
  serviceType     String?       // "MapServer", "FeatureServer", "TileServer", etc.
  serviceTitle    String?       // Title of the parent service
  
  // Layer description and fields
  layerDescription String?      @db.Text
  fields          Json?         // Array of field definitions from service
  
  // Spatial reference
  spatialReference Json?        // WKID or WKT from service
  srid            Int?          // Derived SRID (e.g., 4326 for WGS84)
  
  // Extent information
  extent          Json?         // {xmin, ymin, xmax, ymax} from service
  
  // Caching and metadata
  fetchedAt       DateTime      @default(now())
  lastValidatedAt DateTime?     // When we last verified the service was accessible
  isAccessible    Boolean       @default(true)
  
  // Parent dataset link (if imported into catalog)
  importedDatasetId String?     @unique
  importedDataset     GISDataset? @relation(fields: [importedDatasetId], references: [id], onDelete: SetNull)
  
  // Tracking
  discoveredBy    String?       // How it was discovered (e.g., "map_explorer", "manual")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  createdById     String?
  createdBy       User?         @relation(fields: [createdById], references: [id])
  
  @@unique([serviceUrl, layerId])
  @@index([importedDatasetId])
  @@index([isAccessible])
  @@index([createdAt])
  @@map("remote_gis_datasets")
}

/// Contest within an election (office, ballot measure, etc.)
/// Contests can have different geographic boundaries than their parent election
model Contest {
  id              String      @id @default(cuid())
  
  // Which election
  electionId      String
  election        Election    @relation(fields: [electionId], references: [id], onDelete: Cascade)
  
  // Contest details
  name            String      // "Governor", "Mayor", "Proposition 1", "District 5 Council"
  contestType     String      // "office", "ballot_measure", "judicial"
  district        String?     // "Statewide", "Oakland", "District 5", etc.
  
  // Geographic scope (can differ from election)
  // For statewide: null (uses election boundaries)
  // For city/district: can link to specific geometry dataset
  districtDatasetId String?
  districtDataset   GISDataset? @relation("ContestDistrictDataset", fields: [districtDatasetId], references: [id])
  
  // Metadata
  description     String?     @db.Text
  seatName        String?     // "Seat A", "Position 3" for multi-seat races
  isPartisan      Boolean     @default(true)
  votingMethod    String?     // "plurality", "ranked_choice", "top_two"
  
  // Relations
  choices         ContestChoice[]
  results         ElectionResult[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([electionId, name, district])
  @@index([electionId])
  @@index([contestType])
  @@map("contests")
}

/// Choice in a contest (candidate or ballot option)
model ContestChoice {
  id              String      @id @default(cuid())
  
  // Which contest
  contestId       String
  contest         Contest     @relation(fields: [contestId], references: [id], onDelete: Cascade)
  
  // Choice details
  name            String      // "Gavin Newsom", "Yes", "No"
  choiceType      String      @default("candidate") // "candidate", "yes", "no"
  partyAffiliation String?    // "Democratic", "Republican", null for non-partisan
  
  // Display order
  displayOrder    Int?
  
  // Metadata
  isIncumbent     Boolean     @default(false)
  isWinner        Boolean     @default(false) // Overall winner
  
  // Relations
  results         ElectionResult[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@unique([contestId, name])
  @@index([contestId])
  @@map("contest_choices")
}

/// Election results - vote counts by precinct, contest, and choice
model ElectionResult {
  id                  String      @id @default(cuid())
  
  // Which contest and choice
  contestId           String
  contest             Contest     @relation(fields: [contestId], references: [id], onDelete: Cascade)
  
  choiceId            String
  choice              ContestChoice @relation(fields: [choiceId], references: [id], onDelete: Cascade)
  
  // Precinct link (to dataset containing geometry)
  precinctDatasetId   String
  precinctDataset     PrecinctDataset @relation(fields: [precinctDatasetId], references: [id])
  precinctIdentifier  String      // Actual precinct ID/number (e.g., "PCT-4201")
  
  // Results
  voteCount           Int
  totalVotes          Int?        // Total votes cast in this precinct for this contest
  percentage          Float?      // Calculated: voteCount / totalVotes
  
  // Metadata
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  
  @@unique([contestId, choiceId, precinctIdentifier])
  @@index([contestId])
  @@index([choiceId])
  @@index([precinctDatasetId, precinctIdentifier])
  @@map("election_results")
}

